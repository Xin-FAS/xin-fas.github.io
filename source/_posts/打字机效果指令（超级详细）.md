---
title: æ‰“å­—æœºæ•ˆæœæŒ‡ä»¤ï¼ˆè¶…çº§è¯¦ç»†ï¼‰
date: 2023-08-23 22:23:57
tags: [Vue2, Vue3, JavaScript]
categories: [å‰ç«¯,Vue]
---

## åŸºç¡€ä½¿ç”¨

<iframe src='/iframe/æ‰“å­—æœºæ•ˆæœæŒ‡ä»¤.html' height='100px'></iframe>


æ³¨å†Œï¼ˆvue2ä¸ºä¾‹ï¼‰

```js
import Vue from 'vue'
import write from "./write"

Vue.directive('write', write)
```

ä½¿ç”¨

```html
<script>
export default {
    data () {
        return {
            text: 'æˆ‘è¿˜æ˜¯æˆ‘'
        }
    },
}
</script>

<template>
    <div>
        <button @click="text='ä½ è¿˜æ˜¯ä½ å—'">æ”¹å˜æ–‡å­—</button>
        <p v-write:200.2000.400="text" />
        <p v-write:150.1000="'è¿™æ˜¯ä¸€æ®µè¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§è¶…çº§é•¿çš„æ–‡å­—'" />
    </div>
</template>
```

è§£é‡Šï¼š

æ¯`200ms`æ‰“å°ä¸€ä¸ªå­—ç¬¦ï¼Œæœ€å¼€å§‹ç­‰å¾…`2400msï¼ˆ2000ms + 400msï¼‰`æ‰å¼€å§‹æ‰“å°

> å†’å·åƒæ æ†å°±è¡¨ç¤ºæ‰“å­—çš„é—´éš”ï¼Œç‚¹å°±æ˜¯ç­‰ï¼Œæ˜¯ä¸æ˜¯å¾ˆå¥½è®°ğŸ˜‚

## write.js

è¿™é‡Œä½¿ç”¨åˆ°å°è£…çš„ä¸€ä¸ªå·¥å…·å‡½æ•°ï¼Œ`useFlicker.js`ï¼ˆåŠŸèƒ½å¾…å®Œå–„ï¼‰

```js
/**
 * @author Xin-FAS
 */

// è®©ä¸€ä¸ªå…ƒç´ åˆå§‹é—ªçƒï¼ˆæ¨¡æ‹Ÿæ‰“å­—æ•ˆæœï¼‰
const useFlicker = (el, val = '_') => {
    // æ§åˆ¶é—ªçƒå’Œè¿˜åŸæ–‡å­—
    let interval, timeout
    let text = []
    const setHitStatus = () => el.innerHTML = text.join('') + val
    // å½“å­—ç¬¦ä¸ºç©ºæ—¶ï¼Œä½¿ç”¨ç©ºæ ¼å ä½
    const setTextStatus = () => el.innerHTML = text.length ? text.join('') : '&nbsp;'
    // åˆå§‹åŒ–
    el.innerHTML = ''
    // å¼€å§‹
    const startFlicker = () => {
        el.style.opacity = '1'
        const handler = () => timeout = (setHitStatus(), setTimeout(setTextStatus, 400))
        // ç¬¬ä¸€æ¬¡å¼€å§‹æ—¶å…ˆè§¦å‘ä¸€æ¬¡
        interval = (handler(), setInterval(handler, 1000))
    }
    // å…³é—­æ‰“å­—æ•ˆæœ
    const closeFlicker = () => {
        interval = (clearInterval(interval), undefined)
        timeout = (clearTimeout(timeout), undefined)
        setTextStatus()
    }
    /**
     * æ·»åŠ æ–‡å­—ï¼Œæ”¯æŒå›è°ƒå½¢å¼ï¼Œè¿”å›å€¼ç”¨äºæ›¿æ¢æ–‡å­—æ•°ç»„
     * @param val æ·»åŠ æ–‡å­—
     */
    const addFlickerText = val => {
        const typeofVal = typeof val
        if (typeofVal === 'function') text = val(text)
        if (typeofVal === 'string' || typeofVal === 'number') text.push(val)
        // æ›´æ–°æ˜¾ç¤ºå€¼ + æ‰“å­—çŠ¶æ€
        setHitStatus()
    }
    return {
        startFlicker,
        closeFlicker,
        addFlickerText
    }
}

export { useFlicker }
```

### vue2 ç‰ˆæœ¬

```js
<iframe src="/iframe/FCarouselList/index.html#/" height="700px"></iframe>
```
### vue3 ç‰ˆæœ¬

ä¸æ˜¯`ts`å°±åªæ˜¯ç”Ÿå‘½å‘¨æœŸçš„åŒºåˆ«

1. `bind`æ”¹ä¸ºäº†`mounted`

2. `unbind`æ”¹ä¸ºäº†`unmounted`
3. `update`æ”¹ä¸ºäº†`updated`

```js
/**
 * @author Xin-FAS
 */

import { useFlicker } from '@/utils/useFlicker'
// å­˜å‚¨åŒæ—¶å­˜åœ¨çš„æ‰“å­—æ•ˆæœ
const mapStore = new Map()
const write = {
    // æ“ä½œæ–‡å­—æ‰“å­—æ•ˆæœï¼Œå­˜å‚¨åœ¨è¿™ä¸ªä½ç½®ä¸»è¦æ˜¯ç»™å…¨éƒ¨ç”Ÿå‘½å‘¨æœŸä½¿ç”¨
    async mounted (el, { arg, modifiers, value = '' }) {
        // ç´¯åŠ ç­‰å¾…å€¼
        const delay = Object
            .entries(modifiers).map(v => +v[0])
            .reduce((count, num) => count + num, 0)
        // è¿™é‡Œä¸€å®šè¦åˆ¤æ–­undefinedï¼Œå¦åˆ™arg=0ä¼šèµ‹å€¼150ï¼ŒES11çš„??å¯ä»¥è§£å†³
        const duration = (arg === undefined) ? 150 : +arg
        // åˆå§‹æ‰“å­—åŒ–æ•ˆæœï¼Œå¹¶å¼€å§‹é—ªçƒ
        const flickerHandler = initFlicker(el)
        flickerHandler.startFlicker()
        let delayTime
        // å¼€å§‹ç­‰å¾…
        await new Promise(res => delayTime = setTimeout(res, delay))
        // å®šæ—¶å™¨å¼€å§‹æ‰“å­—
        const innerHTMLArr = value.trim().split('')
        const lastIndex = innerHTMLArr.length - 1
        let activeIndex = 0
        const textInterval = setInterval(() => {
            flickerHandler.addFlickerText(innerHTMLArr[activeIndex++])
            if (activeIndex <= lastIndex) return
            // å…³é—­æ‰“å­—å’Œæ‰“å­—æ•ˆæœ
            clearInterval(textInterval)
            flickerHandler.closeFlicker()
        }, duration)
        // å­˜å…¥å…¨å±€å‡½æ•°
        const handlerEvent = {
            flickerHandler,
            textInterval,
            delayTime
        }
        // åˆ›å»ºä»“åº“keyå¹¶å­˜å…¥ï¼Œéšæœºé˜²æ­¢é‡å¤
        const mapKey = 'map-key' + (Math.random() * 1000).toFixed(5)
        mapStore.set(mapKey, handlerEvent)
        el.setAttribute('map-key', mapKey)
    },
    updated (el, binding) {
        const { value, oldValue } = binding
        // é˜²æ­¢å…¶ä»–åœ°æ–¹çš„åˆ·æ–°
        if (value === oldValue) return
        // ç»“æŸ
        write.unmounted(el)
        // é‡æ–°å¼€å§‹
        write.mounted(el, binding)
    },
    unmounted (el) {
        // è·å–å…ƒç´ ä¸Šçš„æ“ä½œå‡½æ•°
        const mapKey = el.getAttribute('map-key')
        const handlerEvent = mapStore.get(mapKey)
        // æ¸…ç©ºå½“å‰å…ƒç´ ä¸Šçš„æ‰€æœ‰å®šæ—¶å™¨å’Œæ•ˆæœ
        handlerEvent.flickerHandler.closeFlicker()
        clearInterval(handlerEvent.textInterval)
        clearTimeout(handlerEvent.delayTime)
        // å¼€å§‹æ¸…ç©º
        mapStore.delete(mapKey)
        el.removeAttribute('map-key')
    }
}
export default write
```

## è®¾è®¡æ€è·¯

1. ä½¿ç”¨`setInterval`æ“ä½œ`dom`æ·»åŠ å…‰æ ‡ç¬¦å·ï¼Œåšå‡ºæ‰“å­—æ•ˆæœ
2. æ‹†åˆ†æ–‡å­—ï¼Œè¿›è¡Œä¸€ä¸ªä¸ªçš„æ·»åŠ ï¼Œæ·»åŠ æ—¶è¦æ³¨æ„å¤„äºæ‰“å­—çŠ¶æ€ï¼ˆä¹Ÿå°±æ˜¯æ˜¾ç¤ºå…‰æ ‡ï¼‰
3. è¦æ‰“çš„æ–‡å­—ç»“æŸåï¼Œå…³é—­æ§åˆ¶é—ªçƒçš„ä¸¤ä¸ªå®šæ—¶å™¨ï¼Œæ­¤æ—¶å…³é—­åï¼Œæœ€åä¸€æ¬¡è¿˜æœªæ‰§è¡Œï¼Œæ‰€ä»¥è¦æ‰‹åŠ¨è®¾ç½®ä¸€æ¬¡
3. åœ¨æ›´æ–°æ“ä½œæ—¶ï¼Œåˆ¤æ–­å€¼æ›´æ–°åå†é‡æ–°æ‰§è¡Œ

æŒ‡ä»¤å…¶ä¸­çš„`addFlickerText`æ–¹æ³•ï¼Œé¢„ç•™äº†å›è°ƒå½¢å¼æ”¹å˜æ–‡å­—ï¼Œåç»­å¯ä»¥è‡ªå®šä¹‰æ›´å¤šæ•ˆæœï¼ˆå¦‚æ¨¡æ‹Ÿæ‰“é”™äº†åˆ å‡ ä¸ªå†æ‰“ï¼‰

æ›´è¯¦ç»†çš„æµç¨‹è§ä»£ç ä¸­çš„æ³¨é‡Š
